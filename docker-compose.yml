version: "3"

services:
  teslamate:
    image: teslamate/teslamate:latest # teslamate 我们依然使用官方镜像
    restart: always
    environment:
      - ENCRYPTION_KEY=MyTeslaSecretKey2025! # 建议修改为您自己的密钥
      - DATABASE_USER=teslamate
      - DATABASE_PASS=123456
      - DATABASE_NAME=teslamate
      - DATABASE_HOST=database
      - MQTT_HOST=mosquitto
      - TZ=Asia/Shanghai
    ports:
      - "10992:4000"
    volumes:
      - ./import:/opt/app/import
    cap_drop:
      - all

  database:
    image: postgres:16 # database 我们依然使用官方镜像
    restart: always
    environment:
      - POSTGRES_USER=teslamate
      - POSTGRES_PASSWORD=123456
      - POSTGRES_DB=teslamate
    volumes:
      - teslamate-db:/var/lib/postgresql/data

  grafana:
    image: grafana/grafana:latest # grafana 我们依然使用官方镜像
    restart: always
    environment:
      - DATABASE_USER=teslamate
      - DATABASE_PASS=123456
      - DATABASE_NAME=teslamate
      - DATABASE_HOST=database
    ports:
      - "10993:3000"
    volumes:
      - teslamate-grafana-data:/var/lib/grafana

  mosquitto:
    image: eclipse-mosquitto:2 # mosquitto 我们依然使用官方镜像
    restart: always
    command: mosquitto -c /mosquitto-no-auth.conf
    volumes:
      - mosquitto-conf:/mosquitto/config
      - mosquitto-data:/mosquitto/data

  tesla-dashboard:
    # --- 这是最关键的修改 ---
    # 我们删除了 "image:" 指令
    build: /www/wwwroot/tesla-stack/tesla-dashboard  # <-- 新增了 build 指令，请确保路径是您存放代码的真实路径
    # -------------------------
    restart: always
    ports:
      - "3333:3000" # 内部端口
    environment:
      - SKIP_DB_CONNECTION=false
      - DB_HOST=database
      - DB_PORT=5432
      - DB_NAME=teslamate
      - DB_USER=teslamate
      - DB_PASSWORD=123456
      - NEXT_PUBLIC_AMAP_KEY=web端key
      - NEXT_PUBLIC_AMAP_SECURITY_KEY=web端安全密钥
      - AMAP_WEB_SERVICE_web服务key
      - TZ=Asia/Shanghai

volumes:
  teslamate-db:
  teslamate-grafana-data:
  mosquitto-conf:
  mosquitto-data:
